repeat task.wait() until game:IsLoaded()

--// ==================== SERVICES ====================
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local LP = Players.LocalPlayer

--// ==================== CONFIG ====================
local WHITE_ON_START = true              -- b·∫≠t m√†n h√¨nh tr·∫Øng khi load
local WHITE_TOGGLE_KEY = Enum.KeyCode.P  -- ph√≠m toggle tr·∫Øng
local ENABLE_LOW_GFX = true              -- b·∫≠t t·ªëi ∆∞u ƒë·ªì h·ªça
local HARD_HIDE_ALL_PARTS = true         -- ·∫©n to√†n b·ªô map tr·ª´ nh√¢n v·∫≠t
local TRACK_NEW_PARTS = true             -- t·ª± ·∫©n part m·ªõi
local PART_SCAN_INTERVAL = 1.0           -- qu√©t l·∫°i m·ªói 1s
local MAX_HIDE_PER_TICK = 1500           -- tr√°nh lag khi ·∫©n nhi·ªÅu part

--// ==================== WHITE SCREEN + TIMER ====================
local WhiteGui, WhiteFrame, TimerLabel, WhiteOn = nil, nil, nil, false
local startTime = tick()

local function getPlayerGui()
	local pg = LP:FindFirstChildOfClass("PlayerGui")
	if pg then return pg end
	repeat task.wait()
		pg = LP:FindFirstChildOfClass("PlayerGui")
	until pg
	return pg
end

local function ensureWhite()
	if WhiteGui and WhiteGui.Parent then return end

	local pg = getPlayerGui()
	WhiteGui = Instance.new("ScreenGui")
	WhiteGui.Name = "TP_WhiteOverlay"
	WhiteGui.ResetOnSpawn = false
	WhiteGui.IgnoreGuiInset = true
	WhiteGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	WhiteGui.Parent = pg

	WhiteFrame = Instance.new("Frame")
	WhiteFrame.Size = UDim2.fromScale(1, 1)
	WhiteFrame.BackgroundColor3 = Color3.new(1, 1, 1)
	WhiteFrame.BorderSizePixel = 0
	WhiteFrame.Visible = false
	WhiteFrame.Parent = WhiteGui

	TimerLabel = Instance.new("TextLabel")
	TimerLabel.Size = UDim2.new(0, 300, 0, 100)
	TimerLabel.Position = UDim2.fromScale(0.5, 0.5)
	TimerLabel.AnchorPoint = Vector2.new(0.5, 0.5)
	TimerLabel.BackgroundTransparency = 1
	TimerLabel.Text = "00:00:00"
	TimerLabel.TextColor3 = Color3.new(0, 0, 0)
	TimerLabel.TextSize = 48
	TimerLabel.Font = Enum.Font.GothamBold
	TimerLabel.TextStrokeTransparency = 0.8
	TimerLabel.Parent = WhiteFrame
end

local function setWhite(b)
	ensureWhite()
	WhiteOn = b and true or false
	WhiteFrame.Visible = WhiteOn
end

UIS.InputBegan:Connect(function(i, gp)
	if gp then return end
	if i.KeyCode == WHITE_TOGGLE_KEY then
		setWhite(not WhiteOn)
	end
end)

if WHITE_ON_START then
	setWhite(true)
end

RunService.RenderStepped:Connect(function()
	if TimerLabel then
		local elapsed = tick() - startTime
		local h = math.floor(elapsed / 3600)
		local m = math.floor((elapsed % 3600) / 60)
		local s = math.floor(elapsed % 60)
		TimerLabel.Text = string.format("%02d:%02d:%02d", h, m, s)
	end
end)

--// ==================== LOW GRAPHICS ====================
if ENABLE_LOW_GFX then
	pcall(function()
		local rs = settings():GetService("RenderSettings")
		if rs then
			rs.QualityLevel = Enum.QualityLevel.Level01
		end

		Lighting.GlobalShadows = false
		Lighting.EnvironmentDiffuseScale = 0
		Lighting.EnvironmentSpecularScale = 0
		Lighting.ShadowSoftness = 0
		Lighting.Brightness = 1

		for _, v in ipairs(Lighting:GetChildren()) do
			if v:IsA("BloomEffect") or v:IsA("SunRaysEffect")
				or v:IsA("DepthOfFieldEffect")
				or v:IsA("BlurEffect")
				or v:IsA("ColorCorrectionEffect") then
				pcall(function() v.Enabled = false end)
			end
		end

		local ter = workspace:FindFirstChildOfClass("Terrain")
		if ter then
			ter.WaterWaveSize = 0
			ter.WaterWaveSpeed = 0
			ter.WaterReflectance = 0
			ter.WaterTransparency = 1
		end
	end)
end

--// ==================== HIDE MAP ====================
local function isDescendantOf(a, b)
	if not (a and b) then return false end
	local p = a
	while p do
		if p == b then return true end
		p = p.Parent
	end
	return false
end

local function isLocalCharacterPart(part)
	local char = LP and LP.Character
	return char and isDescendantOf(part, char)
end

local hiddenCount = 0

local function hidePart(p)
	if not (p and p:IsA("BasePart")) then return end
	if isLocalCharacterPart(p) then return end
	if p.LocalTransparencyModifier ~= 1 then
		p.LocalTransparencyModifier = 1
		p.CastShadow = false
		hiddenCount += 1
	end
end

local function initialHideAll()
	if not HARD_HIDE_ALL_PARTS then return end
	hiddenCount = 0

	local ok, desc = pcall(workspace.GetDescendants, workspace)
	if ok and type(desc) == "table" then
		local processed = 0
		for i = 1, #desc do
			local d = desc[i]

			if d:IsA("BasePart") then
				hidePart(d)
			end

			if ENABLE_LOW_GFX then
				if d:IsA("ParticleEmitter") or d:IsA("Trail")
					or d:IsA("Fire") or d:IsA("Smoke")
					or d:IsA("Sparkles") then
					pcall(function() d.Enabled = false end)
				elseif d:IsA("Decal") or d:IsA("Texture") then
					pcall(function() d.Transparency = 1 end)
				elseif d:IsA("SurfaceAppearance") then
					pcall(function() d:Destroy() end)
				elseif d:IsA("MeshPart") then
					pcall(function() d.RenderFidelity = Enum.RenderFidelity.Performance end)
				end
			end

			processed += 1
			if processed % MAX_HIDE_PER_TICK == 0 then
				task.wait()
			end
		end
	end

	print(("[CT] Map hidden: %d parts"):format(hiddenCount))
end

initialHideAll()

--// ==================== AUTO TRACK NEW PARTS ====================
if TRACK_NEW_PARTS and HARD_HIDE_ALL_PARTS then
	workspace.DescendantAdded:Connect(function(inst)
		if inst:IsA("BasePart") then
			hidePart(inst)
		end
	end)

	task.spawn(function()
		while task.wait(PART_SCAN_INTERVAL) do
			local ok, desc = pcall(workspace.GetDescendants, workspace)
			if ok and type(desc) == "table" then
				local processed = 0
				for i = 1, #desc do
					local d = desc[i]
					if d:IsA("BasePart") then
						hidePart(d)
					end
					processed += 1
					if processed % MAX_HIDE_PER_TICK == 0 then
						task.wait()
					end
				end
			end
		end
	end)
end
-- ==================================================
-- 3) ·∫®N B·∫¢NG L·ªñI TELEPORT
-- ==================================================
task.spawn(function()
    while task.wait(3) do
        pcall(function()
            local pg = LP:FindFirstChild('PlayerGui')
            if pg then
                for _, gui in ipairs(pg:GetChildren()) do
                    if gui:IsA('ScreenGui') and gui.Enabled then
                        for _, frame in ipairs(gui:GetDescendants()) do
                            if frame:IsA('Frame') or frame:IsA('ImageLabel') then
                                for _, textObj in ipairs(frame:GetDescendants()) do
                                    if textObj:IsA('TextLabel') or textObj:IsA('TextButton') then
                                        local text = string.lower(textObj.Text or '')
                                        local errorKeywords = { '772' }
                                        local isError = false
                                        for _, kw in ipairs(errorKeywords) do
                                            if text:find(kw) then isError = true break end
                                        end
                                        if isError then
                                            frame.Visible = false
                                            gui.Enabled = false
                                            print('üö´ ƒê√£ ·∫©n b·∫£ng l·ªói:', textObj.Text)
                                            for _, btn in ipairs(frame:GetDescendants()) do
                                                if btn:IsA('TextButton') then
                                                    local btnText = string.lower(btn.Text or '')
                                                    if btnText:find('ok') or btnText:find('ƒë√≥ng') or btnText:find('close') then
                                                        pcall(function()
                                                            for _, connection in pairs(getconnections(btn.MouseButton1Click)) do
                                                                connection:Fire()
                                                            end
                                                        end)
                                                    end
                                                end
                                            end
                                            break
                                        end
                                    end
                                end
                            end
                        end
                    end
                end

                pcall(function()
                    local coreGui = game:GetService('CoreGui')
                    for _, gui in ipairs(coreGui:GetChildren()) do
                        if gui:IsA('ScreenGui') then
                            for _, desc in ipairs(gui:GetDescendants()) do
                                if desc:IsA('TextLabel') then
                                    local text = string.lower(desc.Text or '')
                                    if text:find('772') or text:find('773') then
                                        gui.Enabled = false
                                    end
                                end
                            end
                        end
                    end
                end)
            end
        end)
    end
end)
-- ==================================================
-- ‚öôÔ∏è LOCAL TARGET C≈® (d√πng cho isTarget + webhook)
-- ==================================================
local targets = {
    'Chipso and Queso','La Casa Boo','Tang Tang Keletang','Headless Horseman',
    'Strawberry Elephant','Chicleteira Bicicleteira','Los Chicleteiras',
    'La Grande Combinasion','Nuclearo Dinossauro','Esok Sekolah','Ketupat Kepat',
    'Money Money Puggy','Tictac Sahur','Ketchuru and Musturu','Garama and Madundung',
    'Spaghetti Tualetti','Dragon Cannelloni','67','Mariachi Corazoni','Tacorita Bicicleta',
    'La Extinct Grande','Las Sis',
    'Celularcini Viciosini','Los Bros','Tralaledon','Los Tacoritas','Los Primos',
    'Chillin Chili','Los Combinasionas','Los Hotspotsitos','La Supreme Combinasion',
    'Los 67','La Secret Combinasion','Burguro And Fryuro','La Spooky Grande','Los Mobilis',
    'Eviledon','Spooky and Pumpky','Mieteteira Bicicleteira','Los Spooky Combinasionas','Meowl',
    'Los Matteos','Bisonte Guppitere','La Vacca Saturno Saturnita','Los Spiderinis','Los Tralaleritos',
    'Yess My Examine','Las Tralaleritas','Job Job Job Sahur','Las Vaquitas Saturnitas','1x1x1x1','Guest 666',
    'Captiano Moby','La Taco Combinasion','Los Puggies','Los Spaghettis','Fragrama and Chocrama','Orcaledon','Swag Soda'
}

-- ==================================================
-- ‚öôÔ∏è H√ÄM CHUY·ªÇN GENERATION ‚Üí S·ªê (tri·ªáu M)
-- ==================================================
local function parseGeneration(gen)
    if not gen or gen == "" then return 0 end
    gen = tostring(gen):gsub(",", ""):gsub("%s+", ""):upper()
    local num = tonumber(gen:match("([%d%.]+)")) or 0

    if gen:find("B") then
        return num * 1000
    elseif gen:find("M") then
        return num
    elseif gen:find("K") then
        return num / 1000
    elseif gen:find("%$") then
        if num >= 1e9 then return (num / 1e9) * 1000
        elseif num >= 1e6 then return num / 1e6
        elseif num >= 1e3 then return num / 1e3 / 1000
        else return num / 1e6 end
    else
        return num
    end
end

-- ==================================================
-- ‚öôÔ∏è KI·ªÇM TRA TARGET (d√πng local targets c≈©)
-- ==================================================
local function isTarget(name)
    local n = string.lower(name or "")
    for _, t in ipairs(targets) do
        if n:find(string.lower(t), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è LOCAL SPECIAL TARGET (ch·ªâ d√πng cho HIGH)
-- ==================================================
local highSpecialTargets = {
    'Headless Horseman','Meowl','Dragon Cannelloni',
    'Garama and Madundung','Spooky and Pumpky','Burguro And Fryuro',
    'Tang Tang Keletang','Captiano Moby','La Taco Combinasion','Fragrama and Chocrama',
    'La Secret Combinasion','Strawberry Elephant','Ketchuru and Musturu','Eviledon',
}

local function isHighSpecial(name)
    local n = string.lower(name or "")
    for _, s in ipairs(highSpecialTargets) do
        if n:find(string.lower(s), 1, true) then
            return true
        end
    end
    return false
end

-- ==================================================
-- ‚öôÔ∏è WEBHOOK LINKS
-- ==================================================
local webhook_low     = "https://discord.com/api/webhooks/1440746351846490316/l_krmgTzvH91bsxfwQcvDhJtbZqOTuPn1y0qE_wKYbqVJ-5L1KrKakdBpso3zppv1Qc3"
local webhook_high    = "https://discord.com/api/webhooks/1440746259437850747/6Nh1B0WwTLg1LQUliIHF1lyhdLUveDyafH9Z4ZAQzmLTG_VNhxYNi-zHsZ1cFTc5XI_V"
local webhook_index   = "https://discord.com/api/webhooks/1440896096179191968/4j4lSGR_t4AD6TWEJUXYbrsYTmWPWGqF8RaCY5X-jFSUDzzXB6eYkvB2Ny12xUss1N_2"
local webhook_special = "https://discord.com/api/webhooks/1441041394457247795/DcvqpI2-ZS8p6y9aqXVrD6BLQk41Z_iWOVbiVCot5L6Kl1zzkaAGppKcG88Nni6kdPNA"

-- ==================================================
-- ‚öôÔ∏è HTTP REQUEST (t∆∞∆°ng th√≠ch executor)
-- ==================================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

local http_request_impl = nil
if typeof(syn) == "table" and typeof(syn.request) == "function" then
    http_request_impl = syn.request
elseif typeof(http_request) == "function" then
    http_request_impl = http_request
elseif typeof(request) == "function" then
    http_request_impl = request
elseif typeof(http) == "table" and typeof(http.request) == "function" then
    http_request_impl = http.request
end

local sendQueue, sending = {}, false

local function processQueue()
    if sending then return end
    sending = true

    while #sendQueue > 0 do
        local item = table.remove(sendQueue, 1)
        if not http_request_impl then
            warn("‚ùå Kh√¥ng c√≥ http_request_impl, b·ªè qua g·ª≠i Discord.")
            break
        end

        local ok, res = pcall(function()
            return http_request_impl({
                Url = item.url,
                Method = "POST",
                Headers = { ["Content-Type"] = "application/json" },
                Body = HttpService:JSONEncode(item.payload),
            })
        end)

        if ok and res and (res.StatusCode == 204 or res.StatusCode == 200) then
            print("üì§ Webhook OK ‚Üí", item.url)
        else
            warn("‚ö†Ô∏è Webhook l·ªói:", item.url, res and res.StatusCode, res and res.Body)
            -- retry nh·∫π
            table.insert(sendQueue, item)
            task.wait(2)
        end

        task.wait(0.5)
    end

    sending = false
end

local function safeSend(url, payload)
    table.insert(sendQueue, { url = url, payload = payload })
    task.spawn(processQueue)
end

-- ==================================================
-- ‚öôÔ∏è EMBED FULL (low/high/special)
-- ==================================================
llocal function makePayload(list, color, placeId, jobId)
    local players = tostring(#Players:GetPlayers()) .. "/" .. tostring(Players.MaxPlayers)

    local lines = {}
    table.insert(lines, "üè∑Ô∏è ùêçùêöùê¶ùêû              üí∞ ùêåùê®ùêßùêûùê≤/ùê¨") -- ti√™u ƒë·ªÅ b·∫£ng

    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"

        if utf8.len(name) > COLUMN_POS - 2 then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end

        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end

    -- üî• Th√™m Players xu·ªëng cu·ªëi b·∫£ng
    table.insert(lines, "")
    table.insert(lines, ("üë• ùêèùê•ùêöùê≤ùêûùê´ùê¨: %s"):format(players))

    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"

    local joinLink = ("üåê [**ùêÇùê•ùê¢ùêúùê§ ùê≠ùê® ùê£ùê®ùê¢ùêß**](https://chillihub1.github.io/chillihub-joiner/?placeId=%s&gameInstanceId=%s)")
        :format(placeId, jobId)

    local joinScript = string.format(
        "```lua\ngame:GetService('TeleportService'):TeleportToPlaceInstance(%s, '%s', game.Players.LocalPlayer)\n```",
        placeId, jobId
    )

    local footerTime = ("ùêåùêöùêùùêû ùêõùê≤ ùêäùê°ùêöùê¢ùêçùê†ùêÆùê≤ùêûùêß | H√¥m nay l√∫c %s:%s")
        :format(os.date("%H"), os.date("%M"))

    return {
        embeds = { {
            author = { name = "ùêÅùê´ùêöùê¢ùêßùê´ùê®ùê≠ ùêçùê®ùê≠ùê¢ùêüùê≤ | ùêÉùêûùêßùêäùêöùê¢" },
            color  = color or 0x000000,
            description =
                tableBlock ..
                "\nüÜî **ùêâùê®ùêõ ùêàùêÉ ** `" .. jobId .. "`\n" ..
                joinLink .. "\n\nüìú **ùêìùêûùê•ùêûùê©ùê®ùê´ùê≠**\n" .. joinScript,
            footer = { text = footerTime },
        } }
    }
end

-- ==================================================
-- ‚öôÔ∏è EMBED INDEX (ch·ªâ t√™n + ti·ªÅn)
-- ==================================================
local function makeIndexPayload(list)
    local lines = {}
    table.insert(lines, "üè∑Ô∏è ùêçùêöùê¶ùêû              üí∞ ùêåùê®ùêßùêûùê≤/ùê¨")

    local COLUMN_POS = 22
    for _, t in ipairs(list) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "?"

        if utf8.len(name) > (COLUMN_POS - 2) then
            name = string.sub(name, 1, COLUMN_POS - 5) .. "..."
        end

        local pad = math.max(0, COLUMN_POS - utf8.len(name))
        table.insert(lines, string.format("%s%s%s", name, string.rep(" ", pad), gen))
    end

    -- üî• Players ·ªü d∆∞·ªõi c√πng
    table.insert(lines, "")
    table.insert(lines, ("üë• ùêèùê•ùêöùê≤ùêûùê´ùê¨: %s/%s"):format(#Players:GetPlayers(), Players.MaxPlayers))

    local tableBlock = "```\n" .. table.concat(lines, "\n") .. "\n```"
    local footerTime = ("ùêåùêöùêùùêû ùêõùê≤ ùêäùê°ùêöùê¢ùêçùê†ùêÆùê≤ùêûùêß | H√¥m nay l√∫c %s:%s"):format(os.date("%H"), os.date("%M"))

    return {
        embeds = { {
            author = { name = "ùêÅùê´ùêöùê¢ùêßùê´ùê®ùê≠ ùêçùê®ùê≠ùê¢ùêüùê≤ | ùêÉùêûùêßùêäùêöùê¢" },
            color  = 0x000000,
            description = tableBlock,
            footer = { text = footerTime },
        } }
    }
end

-- ==================================================
-- ‚öôÔ∏è H√ÄM CHIA LIST TH√ÄNH NHI·ªÄU CHUNK
-- ==================================================
local function chunkList(list, maxPerChunk)
    local result = {}
    local total = #list
    maxPerChunk = maxPerChunk or 30

    for i = 1, total, maxPerChunk do
        local chunk = {}
        for j = i, math.min(i + maxPerChunk - 1, total) do
            table.insert(chunk, list[j])
        end
        table.insert(result, chunk)
    end

    return result
end

-- ==================================================
-- ‚öôÔ∏è DEDUPE THEO T·ª™NG TARGET / JOB
-- ==================================================
local reportedTargets = {}  -- [jobId] = { ["Name|Gen"] = true }

local function markReported(jobId, name, generation)
    jobId = tostring(jobId or "0")
    name = tostring(name or "Unknown")
    generation = tostring(generation or "N/A")

    local perJob = reportedTargets[jobId]
    if not perJob then
        perJob = {}
        reportedTargets[jobId] = perJob
    end

    local key = name .. "|" .. generation
    if perJob[key] then
        return false
    end

    perJob[key] = true
    return true
end

-- ==================================================
-- ‚öôÔ∏è DELAY C√ÅC WEBHOOK (0 = g·ª≠i ngay)
-- ==================================================
local LOW_DELAY_SEC          = 0   -- 1‚Äì9M  ‚Üí webhook_low
local INDEX_DELAY_SEC        = 0   -- 10M+  ‚Üí webhook_index
local HIGH_NORMAL_DELAY_SEC  = 0   -- 10M+  ‚Üí webhook_high (kh√¥ng special)
local HIGH_SPECIAL_DELAY_SEC = 2   -- 10M+  ‚Üí webhook_high (special)
local ULTRA_DELAY_SEC        = 0   -- 10M+  ‚Üí webhook_special (ultra)

local function sendDelayed(delay, fn)
    if delay and delay > 0 then
        task.delay(delay, fn)
    else
        fn()
    end
end

-- ==================================================
-- ‚öôÔ∏è G·ª¨I WEBHOOK
-- ==================================================
local function sendWebhook(foundTargets)
    if not foundTargets or #foundTargets == 0 then return end

    local placeId, jobId = game.PlaceId, game.JobId

    local groupLow         = {}
    local groupUltra       = {}
    local groupIndex       = {}
    local groupHighNormal  = {}
    local groupHighSpecial = {}

    --------------------------------------------------
    -- L·ªåC TARGET THEO GENERATION
    --------------------------------------------------
    for _, t in ipairs(foundTargets) do
        local name = t.name or "Unknown"
        local gen  = t.generation or "N/A"

        if not isTarget(name) then
            continue
        end

        -- dedupe theo t·ª´ng con trong m·ªói job
        if not markReported(jobId, name, gen) then
            -- ƒë√£ g·ª≠i con n√†y trong job n√†y r·ªìi
            continue
        end

        local val = parseGeneration(gen)
        if val <= 0 then
            continue
        end

        if val >= 10 then
            local rec = { name = name, generation = gen }

            -- ULTRA: 10M+ ‚Üí webhook_special
            table.insert(groupUltra, rec)

            -- INDEX + HIGH: chung 1 t·∫≠p g·ªëc
            table.insert(groupIndex, rec)

            if isHighSpecial(name) then
                table.insert(groupHighSpecial, rec)
            else
                table.insert(groupHighNormal, rec)
            end
        elseif val >= 1 then
            table.insert(groupLow, { name = name, generation = gen })
        end
    end

    if #groupLow == 0 and #groupUltra == 0 and #groupIndex == 0 then
        print("‚ÑπÔ∏è Kh√¥ng c√≥ target h·ª£p l·ªá ƒë·ªÉ g·ª≠i webhook.")
        return
    end

    print(string.format(
        "üì§ B·∫Øt ƒë·∫ßu g·ª≠i webhook ... Low=%d, Ultra=%d, Index=%d, HighNorm=%d, HighSpec=%d",
        #groupLow, #groupUltra, #groupIndex, #groupHighNormal, #groupHighSpecial
    ))

    ------------------------------------------------------
    -- üü° ULTRA (webhook_special): 10M+ full embed
    ------------------------------------------------------
    if #groupUltra > 0 then
        local ultraChunks = chunkList(groupUltra, 30)
        for ci, chunk in ipairs(ultraChunks) do
            local count = #chunk
            sendDelayed(ULTRA_DELAY_SEC, function()
                safeSend(webhook_special, makePayload(chunk, 0xFFD700, placeId, jobId))
                print(string.format(
                    "üö® ULTRA 10M+: chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #ultraChunks, count, ULTRA_DELAY_SEC
                ))
            end)
        end
    end

    ------------------------------------------------------
    -- üîµ INDEX (webhook_index): 10M+ b·∫£ng t√™n + ti·ªÅn
    ------------------------------------------------------
    if #groupIndex > 0 then
        local indexChunks = chunkList(groupIndex, 40)
        print(string.format(
            "‚è±Ô∏è Index(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            INDEX_DELAY_SEC, #groupIndex, #indexChunks
        ))

        sendDelayed(INDEX_DELAY_SEC, function()
            for ci, chunk in ipairs(indexChunks) do
                safeSend(webhook_index, makeIndexPayload(chunk))
                print(string.format(
                    "‚úÖ Index(10M+): chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #indexChunks, #chunk, INDEX_DELAY_SEC
                ))
            end
        end)
    end

    ------------------------------------------------------
    -- üü¢ LOW (webhook_low): 1‚Äì9M full info
    ------------------------------------------------------
    if #groupLow > 0 then
        local count = #groupLow
        sendDelayed(LOW_DELAY_SEC, function()
            safeSend(webhook_low, makePayload(groupLow, 0x00FF00, placeId, jobId))
            print(string.format(
                "üì© Low(1‚Äì9M): %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                count, LOW_DELAY_SEC
            ))
        end)
    end

    ------------------------------------------------------
    -- üî¥ HIGH NORMAL (webhook_high): 10M+ kh√¥ng special
    ------------------------------------------------------
    if #groupHighNormal > 0 then
        local normChunks = chunkList(groupHighNormal, 30)
        print(string.format(
            "‚è±Ô∏è High NORMAL(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            HIGH_NORMAL_DELAY_SEC, #groupHighNormal, #normChunks
        ))

        sendDelayed(HIGH_NORMAL_DELAY_SEC, function()
            for ci, chunk in ipairs(normChunks) do
                safeSend(webhook_high, makePayload(chunk, 0x1A1AFF, placeId, jobId))
                print(string.format(
                    "‚úÖ High NORMAL: chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #normChunks, #chunk, HIGH_NORMAL_DELAY_SEC
                ))
            end
        end)
    end

    ------------------------------------------------------
    -- üî¥ HIGH SPECIAL (webhook_high): 10M+ trong highSpecialTargets
    ------------------------------------------------------
    if #groupHighSpecial > 0 then
        local specChunks = chunkList(groupHighSpecial, 30)
        print(string.format(
            "‚è±Ô∏è High SPECIAL(10M+): s·∫Ω g·ª≠i sau %ds (%d item, %d chunk)",
            HIGH_SPECIAL_DELAY_SEC, #groupHighSpecial, #specChunks
        ))

        sendDelayed(HIGH_SPECIAL_DELAY_SEC, function()
            for ci, chunk in ipairs(specChunks) do
                safeSend(webhook_high, makePayload(chunk, 0x1A1AFF, placeId, jobId))
                print(string.format(
                    "‚úÖ High SPECIAL: chunk %d/%d, %d item(s) ƒë√£ g·ª≠i (delay %ds)",
                    ci, #specChunks, #chunk, HIGH_SPECIAL_DELAY_SEC
                ))
            end
        end)
    end
end

-- ==================================================
-- CHECK TARGETS + LOOP (qu√©t m·ªói 1s)
-- ==================================================
local function checkTargets()
    local foundTargets = {}

    for _, obj in ipairs(workspace:GetDescendants()) do
        if obj:IsA("TextLabel") and obj.Name == "DisplayName" then
            local txt = string.lower(obj.LocalizedText or "")

            -- b·ªè m·∫•y label FUSING
            if string.upper(obj.LocalizedText or "") == "FUSING" then
                continue
            end

            for _, name in ipairs(targets) do
                if string.find(txt, string.lower(name)) then
                    local parent = obj.Parent
                    local isStolen = false
                    local generation = "N/A"

                    if parent then
                        -- check b·ªã FUSING / stolen kh√¥ng
                        local stolenLabel = parent:FindFirstChild("Stolen")
                        if stolenLabel and stolenLabel:IsA("TextLabel") then
                            local stolenText = string.upper(stolenLabel.LocalizedText or "")
                            if stolenText == "FUSING" then
                                isStolen = true
                            end
                        end

                        -- t√¨m text generation
                        for _, child in ipairs(parent:GetChildren()) do
                            if child:IsA("TextLabel") then
                                local childName = string.lower(child.Name or "")
                                local childText = child.LocalizedText or ""

                                if childName:find("generation") or childName:find("gen") then
                                    generation = childText ~= "" and childText or generation
                                    break
                                end

                                if childText:match("^G%d+") or childText:match("^G%d+%s") then
                                    generation = childText
                                    break
                                end
                            end
                        end
                    end

                    if not isStolen then
                        table.insert(foundTargets, { name = name, generation = generation })
                        print("‚úÖ Found valid target:", name, "| Generation:", generation)
                    else
                        print("‚ö†Ô∏è Skipped (FUSING):", name)
                    end

                    break
                end
            end
        end
    end

    return foundTargets
end

print("üéØ CT_WhiteScanner_V2 ƒëang ch·∫°y... (qu√©t m·ªói 1s)")

-- üöÄ STARTUP TURBO: scan LI·ªÄN khi v√†o, 0.1s/l·∫ßn trong 3s ƒë·∫ßu
task.spawn(function()
    print("‚ö° Turbo start: scan ngay khi v√†o game (0.1s/l·∫ßn trong 3s ƒë·∫ßu)...")

    local start = tick()
    local sentFirst = false

    -- Trong 3 gi√¢y ƒë·∫ßu: qu√©t r·∫•t nhanh ƒë·ªÉ b·∫Øt con c√†ng s·ªõm c√†ng t·ªët
    while tick() - start < 3 do
        local initialTargets = checkTargets()
        if #initialTargets > 0 then
            print("‚úÖ L·∫ßn ƒë·∫ßu ƒë√£ t√¨m th·∫•y " .. #initialTargets .. " target, G·ª¨I NGAY!")
            sendWebhook(initialTargets)
            sentFirst = true
            break
        end

        task.wait(0.1) -- 100ms qu√©t l·∫°i m·ªôt l·∫ßn trong giai ƒëo·∫°n turbo
    end

    if not sentFirst then
        print("‚åõ Turbo start kh√¥ng th·∫•y target n√†o, ƒë·ªÉ loop m·ªói 1s x·ª≠ l√Ω ti·∫øp.")
    end
end)

-- üîÅ Loop qu√©t ƒë·ªÅu ƒë·∫∑n m·ªói 1s (gi·ªØ nguy√™n logic c≈©)
task.spawn(function()
    while task.wait(1) do
        local ok2, err = pcall(function()
            local t = checkTargets()
            if #t > 0 then
                sendWebhook(t)
            end
        end)
        if not ok2 then
            warn("‚ö†Ô∏è Scan loop error:", err)
        end
    end
end)

-- Loop qu√©t ƒë·ªÅu ƒë·∫∑n m·ªói 1s
task.spawn(function()
    while task.wait(1) do
        local ok2, err = pcall(function()
            local t = checkTargets()
            if #t > 0 then
                sendWebhook(t)
            end
        end)
        if not ok2 then
            warn("‚ö†Ô∏è Scan loop error:", err)
        end
    end
end)
-- üöÄ CT AUTO JOIN ‚Äì poll 2s, retry 1s (scan 8080‚Äì8095, qu√©t nhanh)
repeat task.wait() until game:IsLoaded()
task.wait(0.2)

local Players         = game:GetService("Players")
local HttpService     = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local LocalPlayer     = Players.LocalPlayer

-- üîß HTTP ch·ªçn
local http_request_impl =
    (syn and syn.request)
    or (typeof(http_request) == "function" and http_request)
    or (typeof(request) == "function" and request)
    or (http and http.request)

if not http_request_impl then
    warn("‚ùå Kh√¥ng c√≥ HTTP.")
    return
end

-- ====== TIMING ======
local POLL_INTERVAL  = 3.0   -- c√≥ job ‚Üí 3s h·ªèi l·∫ßn ti·∫øp theo
local RETRY_INTERVAL = 3.0   -- kh√¥ng job ‚Üí 3s retry
local AFTER_TP_WAIT  = 0.4
-- delay tr∆∞·ªõc khi B·∫ÆT ƒê·∫¶U nh·∫≠n job t·ª´ port
local START_DELAY    = 3.0   -- ‚¨ÖÔ∏è b·∫°n ch·ªânh s·ªë n√†y n·∫øu mu·ªën l√¢u h∆°n / nhanh h∆°n
-- ====================

-- instance name ƒë·ªÉ l·ªách pha gi·ªØa acc
local function getInstanceName()
    local uid = tostring(LocalPlayer.UserId or 0)
    return LocalPlayer.Name .. "_" .. uid:sub(-2)
end

local INSTANCE = getInstanceName()

---------------------------------------------------
-- üîç T√åM PORT 8080‚Äì8095 C√ì PYTHON (ch·∫°y song song)
---------------------------------------------------
local HTTP_URL = nil

local function detectActivePort()
    local found = false

    for p = 8080, 8095 do
        task.spawn(function()
            if found or HTTP_URL then return end

            -- test b·∫±ng /status cho nh·∫π, kh√¥ng ƒÉn job
            local statusUrl = ("http://127.0.0.1:%d/status"):format(p)

            local ok, res = pcall(function()
                return http_request_impl({
                    Url     = statusUrl,
                    Method  = "GET",
                    Timeout = 0.3,       -- ƒë·ªß nhanh nh∆∞ng kh√¥ng qu√° g·∫Øt
                })
            end)

            if not ok or not res then return end
            if res.StatusCode ~= 200 or not res.Body or #res.Body == 0 then return end

            -- th·ª≠ decode JSON xem c√≥ ƒë√∫ng format server m√¨nh kh√¥ng
            local ok_json = pcall(function()
                HttpService:JSONDecode(res.Body)
            end)
            if not ok_json then return end

            if not found and not HTTP_URL then
                found   = true
                HTTP_URL = ("http://127.0.0.1:%d/next?instance=%s"):format(p, INSTANCE)
                print("[DK AutoJoin] ‚úì Found port", p)
            end
        end)
    end

    -- ƒë·ª£i t·ªëi ƒëa ~3s cho ƒë·∫øn khi c√≥ port n√†o tr·∫£ v·ªÅ
    local t0 = tick()
    while not HTTP_URL and (tick() - t0) < 3 do
        task.wait(0.01)
    end

    if not HTTP_URL then
        -- fallback 8080 cho ch·∫Øc (tr∆∞·ªùng h·ª£p Python ch∆∞a ch·∫°y k·ªãp,‚Ä¶)
        HTTP_URL = ("http://127.0.0.1:8080/next?instance=%s"):format(INSTANCE)
        warn("[DK AutoJoin] ‚ö† Kh√¥ng detect ƒë∆∞·ª£c port, d√πng fallback 8080.")
    end
end

detectActivePort()
print("[DK AutoJoin] START at", HTTP_URL)

-- ================== DEDUPE JOB ==================
local recentSet = {}

local function pushRecent(jobId)
    recentSet[jobId] = true
end

-- l·ªách pha 0‚Äì0.3s ƒë·ªÉ nhi·ªÅu acc kh√¥ng b·∫Øn c√πng l√∫c
do
    local h = 0
    for i = 1, #INSTANCE do
        h = (h * 131 + INSTANCE:byte(i)) % 997
    end
    local offset = (h % 300) / 1000
    task.wait(0.3 + offset)
end

-- ‚è±Ô∏è DELAY TR∆Ø·ªöC KHI B·∫ÆT ƒê·∫¶U NH·∫¨N JOB T·ª™ PYTHON
print(string.format("[DK AutoJoin] ‚è± Ch·ªù %.1fs r·ªìi m·ªõi b·∫Øt ƒë·∫ßu nh·∫≠n job t·ª´ port...", START_DELAY))
task.wait(START_DELAY)

-- ================== MAIN LOOP (poll) ==================
task.spawn(function()
    while true do
        local ok_req, response = pcall(function()
            return http_request_impl({
                Url    = HTTP_URL,
                Method = "GET"
            })
        end)

        local jobFound = false

        if ok_req and response and response.Body then
            local ok_json, data = pcall(function()
                return HttpService:JSONDecode(response.Body)
            end)

            if ok_json and type(data) == "table" then
                local jobId   = tostring(data.jobId or "")
                local placeId = tonumber(data.placeId) or game.PlaceId

                if jobId ~= "" and jobId ~= "null" and not recentSet[jobId] then
                    jobFound = true
                    pushRecent(jobId)

                    print("üü¢ JOIN:", jobId)

                    pcall(function()
                        TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
                    end)

                    task.wait(AFTER_TP_WAIT)
                end
            end
        end

        if jobFound then
            task.wait(POLL_INTERVAL)   -- c√≥ job ‚Üí ch·ªù 3s r·ªìi m·ªõi h·ªèi ti·∫øp
        else
            task.wait(RETRY_INTERVAL)  -- kh√¥ng job ‚Üí ch·ªù 3s r·ªìi h·ªèi l·∫°i
        end
    end
end)
